% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-02_LaserFrequencyScanforPLD/2019-12-02T203838_seq_scanLaserFrequency.mat');
% meas = meas20191202T203838;

% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-02_LaserFrequencyScanforPLD/2019-12-02T205916_seq_scanLaserFrequency.mat');
% meas = meas20191202T205916;

% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-02_LaserFrequencyScanforPLD/2019-12-02T194610_seq_scanLaserFrequency.mat');
% meas = meas20191202T194610;

% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-02_LaserFrequencyScanforPLD/2019-12-02T193759_seq_scanLaserFrequency.mat');
% meas = meas20191202T193759;

% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-04_LaserFrequencyScanforPLD/2019-12-04T175110_seq_scanLaserFrequency.mat');
% meas = meas20191204T175110;
load('2019-11-19T192230_seq_transportAtoms.mat')
meas = meas20191119T192230;
%% OPLL ACTIVE FOR BOTH ARMS

%Scanning up in frequency
load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for both/2019-12-05T170313_seq_scanLaserFrequency.mat');
meas = meas20191205T170313;

%% OPLL ACTIVE FOR BOTH ARMS

%Scanning down in frequency
load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for both/2019-12-05T174019_seq_scanLaserFrequency.mat');
meas = meas20191205T174019;

%% OPLL ACTIVE FOR ONE ARM
%Scanning up in frequency

%HDT3 latched ~1Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for one arm/2019-12-05T193228_seq_scanLaserFrequency.mat');
% meas = meas20191205T193228;

%HDT1 latched ~2Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for one arm/HDT1 latched/2019-12-05T215540_seq_scanLaserFrequency.mat');
% meas = meas20191205T215540;

%HDT3 latched ~2Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for one arm/HDT3 latched/2019-12-05T225438_seq_scanLaserFrequency.mat');
% meas = meas20191205T225438;

%HDT1 latched ~2Ghz scan
load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-07_LaserFrequencyScanforPLD/OPLL active for one arm/HDT1 latched/2019-12-07T190344_seq_scanLaserFrequency.mat');
meas = meas20191207T190344;

%HDT3 ~2Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-07_LaserFrequencyScanforPLD/OPLL active for one arm/HDT3 latched/2019-12-07T195630_seq_scanLaserFrequency.mat');
% meas = meas20191207T195630;

%% OPLL ACTIVE FOR ONE ARM
%Scanning down in frequency

%HDT3 latched ~1Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for one arm/2019-12-05T184201_seq_scanLaserFrequency.mat');
% meas = meas20191205T184201;

%HDT1 >2Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for one arm/HDT1 latched/2019-12-05T221245_seq_scanLaserFrequency.mat');
% meas = meas20191205T221245;

%HDT3 latched >2Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL active for one arm/HDT3 latched/2019-12-05T231032_seq_scanLaserFrequency.mat');
% meas = meas20191205T231032;

%HDT1 ~2Ghz scan
load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-07_LaserFrequencyScanforPLD/OPLL active for one arm/HDT1 latched/2019-12-07T192707_seq_scanLaserFrequency.mat');
meas = meas20191207T192707;

%HDT3 ~2Ghz scan
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-07_LaserFrequencyScanforPLD/OPLL active for one arm/HDT3 latched/2019-12-07T201726_seq_scanLaserFrequency.mat');
% meas = meas20191207T201726;

%% OPLL INACTIVE FOR BOTH ARMS
%Scanning up in frequency
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL inactive for both arms/2019-12-05T185829_seq_scanLaserFrequency.mat');
% meas = meas20191205T185829;

%Both latched >2Ghz scan
load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL inactive for both arms/2019-12-05T233727_seq_scanLaserFrequency.mat');
meas = meas20191205T233727;

%% OPLL INACTIVE FOR BOTH ARMS
%Scanning down in frequency
% load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL inactive for both arms/2019-12-05T191411_seq_scanLaserFrequency.mat');
% meas = meas20191205T191411;

%Both latched >2Ghz scan
load('/home/karthik/Documents/MATLAB/adwin/trunk/Scripts/+Karthik/2019-12-05_LaserFrequencyScanforPLD/OPLL inactive for both arms/2019-12-05T235754_seq_scanLaserFrequency.mat');
meas = meas20191205T235754;

%%
Images = struct([]);
figure('Position', [70, 500, 1800, 400])
colours = {[0, 0.4470, 0.7410],[0.8500, 0.3250, 0.0980],[0.9290, 0.6940, 0.1250],[0.4940, 0.1840, 0.5560],[0.4660, 0.6740, 0.1880], [0.6350, 0.0780, 0.1840]};
n = 50;
for i = 1:n
Images{i} = squeeze(meas.runData.images(i,:,:,:));
end

F(n) = struct('cdata',[],'colormap',[]);
mdiff = [];
err = [];
frame = 0;

diffinpixelsX = zeros(1,n);
diffinpixelsY = zeros(1,n);


for i = 1:n
img = Images{i};
f = squeeze(img(1,:,:));
f = f - min (f (:));
f = f / max (f (:));

g = squeeze(img(2,:,:));
g = g - min (g (:));
g = g / max (g (:));

usfac = 100;
[output, Greg] = dftregistration(fft2(f),fft2(g),usfac);
diffinpixelsX(1,i) =  output(4);
diffinpixelsY(1,i) = output(3);

subplot(1,3,1), imagesc(f)
colorbar
title('First Image')

subplot(1,3,2), imagesc(g)
colorbar
title('Second Image')

subplot(1,3,3)

xlabel('Shift (# of Pixels)');
ylabel('Occurences');
title('Shift of atom cloud')

hold on

frame = frame+1;
F (frame) = getframe (gcf);
drawnow
end

h1 = histfit(diffinpixelsX);
h1(1).FaceColor = colours{1}; ...[0 0.4470 0.7410]
h1(1).FaceAlpha = 0.5;
hold on
h2 = histfit(diffinpixelsY);
h2(1).FaceColor = colours{2};
h2(1).FaceAlpha = 0.5;
h2(2).Color = colours{3};
set(get(get(h1(2),'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
set(get(get(h2(2),'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
legend('Along X Axis', 'Along Y Axis');
% mdiff = mean();
% err = std();
% subplot(2,2,4), plot(1, mdiff(1), 'o', 'MarkerFaceColor', colours{1}, 'MarkerEdgeColor', colours{1}, 'MarkerSize', 4)
% errorbar (mdiff, err, 'Color', 'Red', 'LineStyle', 'None')
hold off


% F (frame) = getframe (gcf);
% drawnow
% F = [F repelem(F(end),10)];
% 
% % create the video writer with 1 fps
% writerObj = VideoWriter ( 'PhaseCorrelation.avi' );
% writerObj.FrameRate = 2;
% writerObj.Quality = 100;
% % set the seconds per image
% % open the video writer
% open (writerObj);
% % write the frames to the video
% for i = 1: length (F)
% % convert the image to a frame
% frame = F (i);
% writeVideo (writerObj, frame);
% end
% % close the writer object
% close (writerObj);